import{a as d}from"./vendor-BhvhDhpY.js";import{u as h}from"./useStorage-6AZ-_ceW.js";import{S as j,G as C}from"./ui-D2YqbPcu.js";const R=j.GEAR_INVENTORY,T=()=>{const{data:n=[],setData:o,loading:c,reload:w}=h({key:R,defaultValue:[]}),S=d.useCallback(async i=>{try{await o(i)}catch(v){throw console.error("Error saving inventory:",v),v}},[o]),y=d.useCallback(i=>i?n==null?void 0:n.find(v=>v.id===i):void 0,[n]);return d.useEffect(()=>{const i=v=>{const O=v.detail.gear,p=n==null?void 0:n.map(r=>r.id===O.id?O:r);p&&S(p)};return window.addEventListener("updateInventory",i),()=>{window.removeEventListener("updateInventory",i)}},[n,S]),{inventory:n,loading:c,error:null,setInventory:o,saveInventory:S,loadInventory:w,getGearPiece:y}},I=(n,o,c,w=[],S=[],y)=>{const i={base:{...n},afterRefits:{...n},afterEngineering:{...n},afterGear:{...n},afterSets:{...n},final:{...n}};return w.forEach(r=>{r.stats.forEach(f=>p(f,i.afterRefits,n))}),Object.assign(i.afterEngineering,i.afterRefits),y&&y.stats.forEach(r=>p(r,i.afterEngineering,n)),Object.assign(i.afterGear,i.afterEngineering),Object.values(o).forEach(r=>{if(!r)return;const f=c(r);f&&(p(f.mainStat,i.afterGear,i.afterEngineering),f.subStats.forEach(m=>p(m,i.afterGear,i.afterEngineering)))}),Object.assign(i.afterSets,i.afterGear),v(),Object.assign(i.final,i.afterSets),S.forEach(r=>{r.stats.forEach(f=>p(f,i.final,i.afterEngineering))}),i;function v(){const r=O();Object.entries(r).forEach(([f,m])=>{const b=Math.floor(m/2);if(b===0)return;const k=Object.values(o).map(E=>E&&c(E)).find(E=>E&&E.setBonus&&C[E.setBonus].name===f);if(!(!k||!k.setBonus||!C[k.setBonus].stats))for(let E=0;E<b;E++)C[k.setBonus].stats.forEach(t=>p(t,i.afterSets,i.afterEngineering))})}function O(){const r={};return Object.values(o).forEach(f=>{if(!f)return;const m=c(f);!(m!=null&&m.setBonus)||!C[m.setBonus].name||(r[C[m.setBonus].name]=(r[C[m.setBonus].name]||0)+1)}),r}function p(r,f,m){if(["crit","critDamage","healModifier"].includes(r.name))f[r.name]=(f[r.name]||0)+r.value;else if(r.type==="percentage"){const E=m[r.name]*(r.value/100);f[r.name]+=E}else f[r.name]=(f[r.name]||0)+r.value}},L=j.SHIPS,V=({getGearPiece:n}={})=>{const{data:o=[],setData:c,loading:w}=h({key:L,defaultValue:[]}),[S,y]=d.useState(),i=d.useCallback(async(t,a,e)=>{if(c(o.map(s=>{if(s.id!==t&&s.equipmentLocked&&Object.entries(s.equipment).some(([u,l])=>l===e))return s;if(s.id!==t&&!s.equipmentLocked&&Object.entries(s.equipment).some(([u,l])=>l===e)){const u={...s.equipment};return Object.entries(u).forEach(([l,q])=>{q===e&&delete u[l]}),{...s,equipment:u}}return s.id===t?{...s,equipment:{...s.equipment,[a]:e}}:s})),n){const s=n(e);if(s){const u={...s,shipId:t},l=new CustomEvent("updateInventory",{detail:{gear:u}});window.dispatchEvent(l)}}},[o,n,c]),v=d.useCallback((t,a)=>{c(o.map(e=>{if(e.id===t){const s={...e.equipment};return delete s[a],{...e,equipment:s}}return e}))},[o,c]),O=d.useCallback(async t=>{c(o.filter(a=>a.id!==t))},[o,c]),p=d.useCallback(async t=>{const a=o.some(e=>e.id===t.id)?o.map(e=>e.id===t.id?t:e):[...o,t];await c(a),y(void 0)},[o,c]),r=d.useCallback(t=>o.find(a=>a.id===t),[o]),f=d.useCallback(async t=>{const a=o.map(e=>e.id===t.id?{...t}:e);await c(a)},[o,c]),m=d.useCallback(async t=>{try{const a=!t.equipmentLocked;return await f({...t,equipmentLocked:a}),a}catch(a){throw console.error("Failed to update equipment lock state:",a),a}},[f]),b=d.useCallback(()=>{if(!n)return;const t=o.map(a=>{const e={...a.equipment};let s=!1;return Object.entries(e).forEach(([u,l])=>{if(l){const q=n(l);(!q||q.shipId&&q.shipId!==a.id)&&(delete e[u],s=!0)}}),s?{...a,equipment:e}:a});JSON.stringify(t)!==JSON.stringify(o)&&c(t)},[o,n,c]);d.useEffect(()=>{n&&!w&&b()},[n,w,b]);const k=d.useCallback(async t=>{c(o.map(a=>a.id===t?(Object.entries(a.equipment).filter(([s,u])=>u).map(([s,u])=>u).forEach(s=>{if(n){const u=n(s);if(u){const l=new CustomEvent("updateInventory",{detail:{gear:{...u,shipId:""}}});window.dispatchEvent(l)}}}),{...a,equipment:{}}):a))},[o,c,n]),E=d.useCallback(async(t,a)=>{c(o.map(e=>{if(a.filter(({gearId:u})=>o.some(l=>l.id!==t&&l.equipmentLocked&&Object.values(l.equipment).includes(u))).length>0)return e;if(e.id===t){const u={...e.equipment};return a.forEach(({slot:l,gearId:q})=>{u[l]=q}),{...e,equipment:u}}if(!e.equipmentLocked){const u={...e.equipment};let l=!1;if(Object.entries(u).forEach(([q,g])=>{a.some(B=>B.gearId===g)&&(delete u[q],l=!0)}),l)return{...e,equipment:u}}return e})),n&&a.forEach(({gearId:e})=>{const s=n(e);if(s){const u=new CustomEvent("updateInventory",{detail:{gear:{...s,shipId:t}}});window.dispatchEvent(u)}})},[o,c,n]);return{ships:o,loading:w,editingShip:S,setEditingShip:y,handleEquipGear:i,handleRemoveGear:v,handleRemoveShip:O,handleSaveShip:p,getShipById:r,updateShip:f,validateGearAssignments:b,handleLockEquipment:m,handleUnequipAllGear:k,handleEquipMultipleGear:E}};export{V as a,I as c,T as u};
