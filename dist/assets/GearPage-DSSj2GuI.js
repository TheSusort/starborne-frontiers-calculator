import{k as w,G as V,R as B,l as H,j as n,m as T,I as _,B as q,n as J,o as N,e as M,u as K,P as k,h as $,p as z,i as X}from"./ui-D2YqbPcu.js";import{a as m}from"./vendor-BhvhDhpY.js";import{S as Y}from"./StatModifierInput-CjKO7zbw.js";import{P as Q,F as W,S as Z,H as P,a as ee}from"./stat-values-B318iqG1.js";import{G as ae}from"./GearInventory-YrEp50QN.js";import{c as F}from"./scoring-AiKeAj3b.js";import{c as te,u as se,a as ne}from"./useShips-RXMfKXLW.js";import{G as re}from"./GearPieceDisplay-BCww8SQc.js";import"./useStorage-6AZ-_ceW.js";import"./firebaseStorage-B0eyI6ev.js";import"./StatDisplay-zLjdPrVG.js";function U(s,a,l,u){var r;let t;return a==="percentage"?t=Q:s==="hp"?t=W:s==="speed"?t=Z:s==="hacking"||s==="security"?t=P:t=ee,(r=t[l])!=null&&r[u]?t[l][u]:0}const le=({onSubmit:s,editingPiece:a})=>{const[l,u]=m.useState((a==null?void 0:a.slot)||"weapon"),[t,r]=m.useState((a==null?void 0:a.mainStat)||{name:"attack",value:0,type:"flat"}),[d,p]=m.useState((a==null?void 0:a.subStats)||[]),[S,f]=m.useState((a==null?void 0:a.rarity)||"rare"),[c,i]=m.useState((a==null?void 0:a.stars)||1),[v,b]=m.useState((a==null?void 0:a.setBonus)||"FORTITUDE"),[x,A]=m.useState((a==null?void 0:a.level)||0),E=m.useRef(!0);m.useEffect(()=>{a&&(u(a.slot),r(a.mainStat),p(a.subStats),f(a.rarity),i(a.stars),b(a.setBonus),A(a.level))},[a]);const I=e=>J[e],C=e=>w[e].allowedTypes;m.useEffect(()=>{if(!a){const e=I(l);e.includes(t.name)||r({name:e[0],value:0,type:"flat"})}},[l,a,t.name,t.value]),m.useEffect(()=>{if(!a&&!E.current){const e=U(t.name,t.type,c,x);e!==t.value&&r(o=>({...o,value:e}))}},[c,x,t.name,t.type,t.value,a]),m.useEffect(()=>{E.current=!1},[]);const g=m.useCallback(e=>{if(e.name){const o=w[e.name].allowedTypes;e.type=o.includes(t.type)?t.type:o[0]}if(e.value!==void 0){const o=w[e.name||t.name],j=e.type||t.type;e.value=Math.min(e.value,o.maxValue[j])}r(o=>({...o,...e}))},[t.type,t.name]),G=e=>{e.preventDefault();const o=d.map(h=>{if(h.name===t.name)return{...h,type:t.type==="flat"?"percentage":"flat"};const O=w[h.name].allowedTypes;return O.includes(h.type)?h:{...h,type:O[0]}}),j={id:(a==null?void 0:a.id)||Date.now().toString(),slot:l,mainStat:t,subStats:o,setBonus:v,stars:c,rarity:S,level:x,shipId:(a==null?void 0:a.shipId)||""};s(j),p([]),i(1),A(0),u("weapon"),r({name:"attack",value:0,type:"flat"}),f("rare"),b("FORTITUDE")},D=Object.entries(V).map(([e,o])=>({value:e,label:o.name})),R=Object.entries(B).map(([e,o])=>({value:e,label:o.label})),y=Object.entries(H).map(([e,o])=>({value:e,label:o.label}));return n.jsxs("form",{onSubmit:G,className:"space-y-6  bg-dark p-6",children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n.jsx(T,{label:"Set Bonus",value:v,onChange:e=>b(e),options:D}),n.jsx(T,{label:"Slot",value:l,onChange:e=>u(e),options:y}),n.jsx(T,{label:"Stars",value:c.toString(),onChange:e=>i(Number(e)),options:[1,2,3,4,5,6].map(e=>({value:e.toString(),label:`${e} ⭐`}))}),n.jsx(_,{type:"number",label:"Level",value:x,min:0,max:16,onChange:e=>A(Math.min(16,Math.max(0,Number(e.target.value))))}),n.jsx(T,{label:"Rarity",value:S,onChange:e=>f(e),options:R}),n.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[n.jsx(T,{label:"Main Stat",value:t.name,onChange:e=>g({name:e}),options:I(l).map(e=>({value:e,label:w[e].label})),"data-testid":"main-stat-select"}),n.jsx(_,{label:"Main Stat Value",type:"number",value:t.value,onChange:e=>g({value:Number(e.target.value)}),className:"w-32",labelClassName:"invisible"}),(l==="sensor"||l==="software"||l==="thrusters")&&n.jsx(T,{value:t.type,onChange:e=>g({type:e}),options:C(t.name).map(e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)})),className:"w-32"})]})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsx("h4",{className:"text-sm font-medium ",children:"Sub Stats"}),n.jsx(Y,{stats:d,onChange:p,maxStats:4,excludedStats:[{name:t.name,type:t.type}]})]}),n.jsx("div",{className:"flex justify-end pt-4",children:n.jsx(q,{"aria-label":a?"Save gear piece":"Add gear piece",type:"submit",children:a?"Save Gear Piece":"Add Gear Piece"})})]})},oe={rare:{increases:[4,8],additions:[12,16],initialSubstats:2},epic:{increases:[4,8,12],additions:[16],initialSubstats:3},legendary:{increases:[4,8,12,16],additions:[],initialSubstats:4}};function ue(s,a){const l=[];return Object.entries(w).forEach(([u,t])=>{const r=u;if(r===a.name)return;const d=t.allowedTypes.filter(p=>!s.some(S=>S.name===r&&S.type===p));d.length>0&&l.push({name:r,types:d})}),l}function ce(s,a){var r;const l=(r=N[s.name])==null?void 0:r[s.type];if(!l)return 0;const{min:u,max:t}=l;switch(a){case"rare":return u;case"epic":return Math.floor((u+t)/2);case"legendary":return t;default:return 0}}function ie(s,a=16){if(s.level>=a)return s;const l=oe[s.rarity];if(!l)return s;const u={...s},t=U(s.mainStat.name,s.mainStat.type,s.stars,a);u.mainStat={...s.mainStat,value:t};const r=[...s.subStats],d=[];for(let p=s.level+4;p<=a;p+=4)d.push(p);return d.forEach(p=>{var S;if(l.additions.includes(p)){const f=ue(r,s.mainStat);if(f.length>0){const c=f[Math.floor(Math.random()*f.length)],i=c.types[Math.floor(Math.random()*c.types.length)];if((S=N[c.name])!=null&&S[i]){const v=Math.floor(N[c.name][i].min+Math.random()*(N[c.name][i].max-N[c.name][i].min));r.push({name:c.name,type:i,value:v})}}}else if(l.increases.includes(p)){const f=Math.floor(Math.random()*r.length),c=r[f],i=ce(c,s.rarity);i>0&&(r[f]={...c,value:c.value+i})}}),u.subStats=r,u.level=a,u}function L(s){return te({hp:2e4,attack:5e3,defence:4e3,hacking:150,security:50,speed:80,crit:50,critDamage:0,healModifier:0},{[s.slot]:s.id},l=>l===s.id?s:void 0,[],[],void 0).final}function me(s,a,l=3){return s.filter(r=>r.level<16&&["rare","epic","legendary"].includes(r.rarity)).map(r=>{const d=L(r),p=F(d,[],a),S=Array.from({length:100},()=>{const c=ie(r),i=L(c),v=F(i,[],a);return{piece:c,score:v}}),f=S.reduce((c,i)=>c+i.score,0)/S.length;return{piece:r,currentScore:p,potentialScore:f,improvement:f-p}}).sort((r,d)=>d.potentialScore-r.potentialScore).slice(0,l)}const pe=["text-yellow-500","text-gray-400","text-amber-600"],de=({inventory:s,shipRoles:a})=>n.jsxs("div",{className:"space-y-8",children:[n.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gear Upgrade Analysis (EXPERIMENTAL)"}),n.jsx("span",{className:"text-sm text-gray-400",children:"This analysis tries to find the 3 best gear upgrades for each ship role, by simulating upgrading each piece to 16, 10 different times, and averaging the results. The results are percentages of improvement to the role score over the current level of the piece."}),a.map(l=>{const u=me(s,M[l].name);return u.length===0?null:n.jsxs("div",{className:"space-y-4 bg-dark p-4",children:[n.jsx("h3",{className:"text-lg font-medium",children:M[l].name}),n.jsx("span",{className:"text-sm text-gray-400",children:M[l].description}),n.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map((t,r)=>n.jsxs("div",{className:"space-y-2",children:[n.jsx(re,{gear:t.piece}),n.jsx("div",{className:"text-sm px-4 pb-4",children:n.jsxs("div",{className:`flex justify-between ${pe[r]}`,children:[n.jsx("span",{children:"Average improvement:"}),n.jsxs("span",{children:[Math.round(t.improvement/t.currentScore*100),"%"]})]})})]},t.piece.id))})]},l)})]}),Ee=()=>{const{inventory:s,loading:a,error:l,saveInventory:u}=se(),[t,r]=m.useState(),[d,p]=m.useState(!1),{addNotification:S}=K(),{ships:f}=ne(),[c,i]=m.useState(!1),[v,b]=m.useState(null),[x,A]=m.useState(!1),[E,I]=m.useState("inventory"),C=[{id:"inventory",label:"Inventory"},{id:"analysis",label:"Upgrade Analysis"}];m.useEffect(()=>{(async()=>{const e=s.map(o=>{if(o.shipId){const j=f.find(h=>h.id===o.shipId);if(!j||!Object.values(j.equipment).includes(o.id))return{...o,shipId:""}}return o});JSON.stringify(e)!==JSON.stringify(s)&&await u(e)})()},[s,f,u]);const g=async y=>{const e=s.find(o=>o.id===y);A(!!(e!=null&&e.shipId)),b(y),i(!0)},G=async y=>{const e=s.filter(o=>o.id!==y);await u(e),S("success","Gear piece removed successfully"),b(null),i(!1)},D=y=>{window.scrollTo({top:0,behavior:"smooth"}),r(y),p(!0)},R=async y=>{let e;t?e=s.map(o=>o.id===y.id?y:o):e=[...s,y],await u(e),r(void 0),p(!1),window.scrollTo({top:0,behavior:"smooth"}),S("success","Gear piece saved successfully")};return a?n.jsx(k,{title:"Gear Management",children:n.jsx("div",{className:"flex items-center justify-center",children:n.jsx("div",{className:"animate-pulse text-xl ",children:"Loading inventory..."})})}):n.jsxs(k,{title:"Gear Management",description:"Manage your gear and its stats.",action:{label:d?"Hide Form":"Create",onClick:()=>{t&&r(void 0),p(!d)},variant:d?"secondary":"primary"},children:[l&&n.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700",children:l}),n.jsx($,{isVisible:d||!!t,children:n.jsx(le,{onSubmit:R,editingPiece:t})}),n.jsx(z,{tabs:C,activeTab:E,onChange:I}),E==="inventory"?n.jsx(n.Fragment,{children:n.jsx(ae,{inventory:s,onRemove:g,onEdit:D})}):n.jsx(de,{inventory:s,shipRoles:Object.keys(M)}),n.jsx(X,{isOpen:c,onClose:()=>{i(!1),b(null)},onConfirm:()=>v&&G(v),title:"Delete Gear Piece",message:x?"This gear piece is currently equipped. Are you sure you want to delete it?":"Are you sure you want to delete this gear piece?",confirmLabel:"Delete",cancelLabel:"Cancel"})]})};export{Ee as GearPage,Ee as default};
